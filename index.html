<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스마트팜 모니터링</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container py-4">
        <div class="main-header">
            <h1><i class="fas fa-seedling"></i> 스마트팜 모니터링</h1>
            <p>실시간 환경 정보와 모터, 카메라 상태를 한눈에!</p>
        </div>
        <!-- 센서 카드 -->
        <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
                <div class="card sensor-card text-center py-4" id="tempCard">
                    <div class="sensor-icon"><i class="fas fa-thermometer-half"></i></div>
                    <div class="sensor-value" id="temperature">--</div>
                    <div class="sensor-unit">온도 (°C)</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card sensor-card text-center py-4" id="humCard">
                    <div class="sensor-icon"><i class="fas fa-tint"></i></div>
                    <div class="sensor-value" id="humidity">--</div>
                    <div class="sensor-unit">습도 (%)</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card sensor-card text-center py-4" id="ecCard">
                    <div class="sensor-icon"><i class="fas fa-bolt"></i></div>
                    <div class="sensor-value" id="ec">--</div>
                    <div class="sensor-status" id="ecStatus"></div>
                    <div class="sensor-unit">EC (us/cm)</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card sensor-card text-center py-4" id="phCard">
                    <div class="sensor-icon"><i class="fas fa-flask"></i></div>
                    <div class="sensor-value" id="ph">--</div>
                    <div class="sensor-status" id="phStatus"></div>
                    <div class="sensor-unit">pH</div>
                </div>
            </div>
        </div>
        <!-- 그래프 -->
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <div class="card sensor-card">
                    <div class="card-header bg-white border-0">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> 온도/습도 그래프</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="tempHumChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card sensor-card">
                    <div class="card-header bg-white border-0">
                        <h5 class="mb-0"><i class="fas fa-chart-area"></i> EC/pH 그래프</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="ecPhChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 모터 상태 & 사진 -->
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <div class="motor-card">
                    <div class="motor-status" id="motorStatus">
                        <i class="fas fa-cog"></i>
                        <span id="pumpStatusText">OFF</span>
                    </div>
                    <div class="photo-info" id="lastUpdate">마지막 업데이트: --</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="photo-card">
                    <button id="captureBtn" class="btn btn-primary mb-2">
                        <i class="fas fa-camera"></i> 사진 촬영
                    </button>
                    <p class="photo-status" id="photoStatus">준비 완료</p>
                    <img id="cameraImage" alt="현장 스냅샷" style="display: none;">
                    <p class="photo-info" id="photoTime">촬영 시간: --</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Firebase 및 config.js를 반드시 아래 순서로! -->
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js"></script>
    <script src="config.js"></script>
    <script>
        // window.firebaseConfig를 사용
        const app = firebase.initializeApp(window.firebaseConfig);
        const db = firebase.database();

        // Chart.js 차트 초기화
        const tempHumChart = new Chart(document.getElementById('tempHumChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: '온도 (°C)',
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231,76,60,0.08)',
                        data: [],
                        yAxisID: 'y'
                    },
                    {
                        label: '습도 (%)',
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52,152,219,0.08)',
                        data: [],
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: '온도 (°C)' }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: '습도 (%)' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });

        const ecPhChart = new Chart(document.getElementById('ecPhChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'EC (us/cm)',
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46,204,113,0.08)',
                        data: [],
                        yAxisID: 'y'
                    },
                    {
                        label: 'pH',
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155,89,182,0.08)',
                        data: [],
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'EC (us/cm)' }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'pH' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });

        // 상태 판정 함수
        function getECStatus(ec) {
            if (ec === undefined || isNaN(ec)) return {icon: '', text: '', cls: ''};
            if (ec < 2000) return {icon: 'fa-arrow-down', text: '낮음', cls: 'status-warning'};
            if (ec > 3500) return {icon: 'fa-arrow-up', text: '높음', cls: 'status-danger'};
            return {icon: 'fa-check-circle', text: '정상', cls: 'status-normal'};
        }
        function getPHStatus(ph) {
            if (ph === undefined || isNaN(ph)) return {icon: '', text: '', cls: ''};
            if (ph < 5.5) return {icon: 'fa-arrow-down', text: '산성', cls: 'status-danger'};
            if (ph > 6.5) return {icon: 'fa-arrow-up', text: '알칼리', cls: 'status-danger'};
            return {icon: 'fa-check-circle', text: '정상', cls: 'status-normal'};
        }

        // 실시간 센서 데이터 반영
        db.ref('sensor_data').on('value', snapshot => {
            const data = snapshot.val();
            if (!data) return;
            document.getElementById('temperature').textContent = data.temperature?.toFixed(1) ?? '--';
            document.getElementById('humidity').textContent = data.humidity?.toFixed(1) ?? '--';
            document.getElementById('ec').textContent = data.ec?.toFixed(1) ?? '--';
            document.getElementById('ph').textContent = data.ph?.toFixed(1) ?? '--';

            // EC/pH 상태 표시
            const ecStatus = getECStatus(data.ec);
            const phStatus = getPHStatus(data.ph);
            const ecStatusDiv = document.getElementById('ecStatus');
            const phStatusDiv = document.getElementById('phStatus');
            ecStatusDiv.innerHTML = ecStatus.icon ? `<i class="fas ${ecStatus.icon}"></i> <span>${ecStatus.text}</span>` : '';
            ecStatusDiv.className = 'sensor-status ' + ecStatus.cls;
            phStatusDiv.innerHTML = phStatus.icon ? `<i class="fas ${phStatus.icon}"></i> <span>${phStatus.text}</span>` : '';
            phStatusDiv.className = 'sensor-status ' + phStatus.cls;

            // 모터 상태 표시
            const pumpStatusText = document.getElementById('pumpStatusText');
            const motorStatus = document.getElementById('motorStatus');
            let status = data.pump_status;
            if (typeof status === 'boolean') status = status ? 'ON' : 'OFF';
            pumpStatusText.textContent = status ?? '--';
            motorStatus.className = 'motor-status ' + (status === 'ON' ? 'motor-on' : 'motor-off');

            // 마지막 업데이트 시간
            if (data.timestamp) {
                document.getElementById('lastUpdate').textContent =
                    '마지막 업데이트: ' + new Date(data.timestamp).toLocaleString();
            }

            // 차트 데이터 업데이트
            const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : '';
            if (timestamp) {
                tempHumChart.data.labels.push(timestamp);
                tempHumChart.data.datasets[0].data.push(data.temperature);
                tempHumChart.data.datasets[1].data.push(data.humidity);
                if (tempHumChart.data.labels.length > 20) {
                    tempHumChart.data.labels.shift();
                    tempHumChart.data.datasets[0].data.shift();
                    tempHumChart.data.datasets[1].data.shift();
                }
                tempHumChart.update();

                ecPhChart.data.labels.push(timestamp);
                ecPhChart.data.datasets[0].data.push(data.ec);
                ecPhChart.data.datasets[1].data.push(data.ph);
                if (ecPhChart.data.labels.length > 20) {
                    ecPhChart.data.labels.shift();
                    ecPhChart.data.datasets[0].data.shift();
                    ecPhChart.data.datasets[1].data.shift();
                }
                ecPhChart.update();
            }
        });

        // 사진 관련 기능
        const captureBtn = document.getElementById('captureBtn');
        const photoStatus = document.getElementById('photoStatus');
        const cameraImage = document.getElementById('cameraImage');
        const photoTime = document.getElementById('photoTime');

        async function takePhoto() {
            captureBtn.disabled = true;
            captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 촬영 중...';
            photoStatus.textContent = "카메라 준비 중...";
            photoStatus.style.color = "#3498db";

            try {
                await db.ref('control/take_photo').set(true);

                const photoStatusRef = db.ref('control/photo_status');
                const listener = photoStatusRef.on('value', snapshot => {
                    const status = snapshot.val();
                    if (status) {
                        if (status === "success") {
                            photoStatus.textContent = "최근 촬영: 성공";
                            photoStatus.style.color = "#00b894";
                        } else if (status === "failed") {
                            photoStatus.textContent = "최근 촬영: 실패";
                            photoStatus.style.color = "#d63031";
                        }
                        photoStatusRef.off('value', listener);
                        photoStatusRef.set(null);
                    }
                });
            } catch (error) {
                photoStatus.textContent = "촬영 요청 실패";
                photoStatus.style.color = "#d63031";
            } finally {
                setTimeout(() => {
                    captureBtn.disabled = false;
                    captureBtn.innerHTML = '<i class="fas fa-camera"></i> 사진 촬영';
                }, 3000);
            }
        }

        db.ref('latest_photo').on('value', snapshot => {
            const data = snapshot.val();
            if (data && data.url) {
                cameraImage.src = data.url + "?t=" + Date.now();
                cameraImage.style.display = 'block';
                if (data.timestamp) {
                    photoTime.textContent = `촬영 시간: ${data.timestamp}`;
                }
            } else {
                cameraImage.style.display = 'none';
                photoTime.textContent = '촬영 시간: --';
            }
        });

        captureBtn.addEventListener('click', takePhoto);
    </script>
</body>
</html>
